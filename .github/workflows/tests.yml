name: CI

on:
  push:
    branches:
      - main
  pull_request:
  merge_group:

env:
  HOMEBREW_DEVELOPER: 1
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSTALL_FROM_API: 1
  HOMEBREW_GITHUB_API_TOKEN: ${{ github.token }}

concurrency:
  group: "ci-${{ github.ref }}"
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

permissions:
  contents: read

jobs:
  # =============================================================================
  # SYNTAX CHECK - Runs on all PRs and pushes (fast, Linux-compatible)
  # =============================================================================
  tap-syntax:
    name: Tap Syntax
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/homebrew/ubuntu22.04:main
    env:
      HOMEBREW_SIMULATE_MACOS_ON_LINUX: 1
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          core: true
          cask: true

      - name: Cache style cache
        uses: actions/cache@v4
        with:
          path: /home/linuxbrew/.cache/Homebrew/style
          key: style-cache-${{ github.sha }}
          restore-keys: style-cache-

      - name: Run brew test-bot --only-tap-syntax
        run: brew test-bot --only-tap-syntax

  # =============================================================================
  # DETECT CHANGES - Identify new and modified formulas/casks
  # =============================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      formulas: ${{ steps.detect.outputs.formulas }}
      new_formulas: ${{ steps.detect.outputs.new_formulas }}
      modified_formulas: ${{ steps.detect.outputs.modified_formulas }}
      casks: ${{ steps.detect.outputs.casks }}
      new_casks: ${{ steps.detect.outputs.new_casks }}
      modified_casks: ${{ steps.detect.outputs.modified_casks }}
      has_formula_changes: ${{ steps.detect.outputs.has_formula_changes }}
      has_cask_changes: ${{ steps.detect.outputs.has_cask_changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect formula and cask changes
        id: detect
        run: |
          # Get changed files
          ADDED_FILES=$(git diff --name-only --diff-filter=A origin/${{ github.base_ref }}...HEAD)
          MODIFIED_FILES=$(git diff --name-only --diff-filter=M origin/${{ github.base_ref }}...HEAD)
          
          # Detect new formulas
          NEW_FORMULAS=$(echo "$ADDED_FILES" | grep '^Formula/.*\.rb$' | xargs -I {} basename {} .rb | tr '\n' ' ' | xargs)
          MODIFIED_FORMULAS=$(echo "$MODIFIED_FILES" | grep '^Formula/.*\.rb$' | xargs -I {} basename {} .rb | tr '\n' ' ' | xargs)
          ALL_FORMULAS="$NEW_FORMULAS $MODIFIED_FORMULAS"
          
          # Detect new casks
          NEW_CASKS=$(echo "$ADDED_FILES" | grep '^Casks/.*\.rb$' | xargs -I {} basename {} .rb | tr '\n' ' ' | xargs)
          MODIFIED_CASKS=$(echo "$MODIFIED_FILES" | grep '^Casks/.*\.rb$' | xargs -I {} basename {} .rb | tr '\n' ' ' | xargs)
          ALL_CASKS="$NEW_CASKS $MODIFIED_CASKS"
          
          # Set outputs
          echo "formulas=${ALL_FORMULAS}" >> "$GITHUB_OUTPUT"
          echo "new_formulas=${NEW_FORMULAS}" >> "$GITHUB_OUTPUT"
          echo "modified_formulas=${MODIFIED_FORMULAS}" >> "$GITHUB_OUTPUT"
          echo "casks=${ALL_CASKS}" >> "$GITHUB_OUTPUT"
          echo "new_casks=${NEW_CASKS}" >> "$GITHUB_OUTPUT"
          echo "modified_casks=${MODIFIED_CASKS}" >> "$GITHUB_OUTPUT"
          
          # Set flags
          if [ -n "$ALL_FORMULAS" ]; then
            echo "has_formula_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_formula_changes=false" >> "$GITHUB_OUTPUT"
          fi
          
          if [ -n "$ALL_CASKS" ]; then
            echo "has_cask_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_cask_changes=false" >> "$GITHUB_OUTPUT"
          fi
          
          # Summary
          {
            echo "### ðŸ“¦ Detected Changes"
            echo ""
            if [ -n "$NEW_FORMULAS" ]; then
              echo "**New Formulas:** $NEW_FORMULAS"
            fi
            if [ -n "$MODIFIED_FORMULAS" ]; then
              echo "**Modified Formulas:** $MODIFIED_FORMULAS"
            fi
            if [ -n "$NEW_CASKS" ]; then
              echo "**New Casks:** $NEW_CASKS"
            fi
            if [ -n "$MODIFIED_CASKS" ]; then
              echo "**Modified Casks:** $MODIFIED_CASKS"
            fi
            if [ -z "$ALL_FORMULAS" ] && [ -z "$ALL_CASKS" ]; then
              echo "No formula or cask changes detected."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # =============================================================================
  # FORMULA TESTING - Test formulas with brew test-bot
  # =============================================================================
  test-formulas:
    name: Test Formulas (${{ matrix.os }})
    needs: [tap-syntax, detect-changes]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.has_formula_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15]
    runs-on: ${{ matrix.os }}
    permissions:
      actions: read
      checks: read
      contents: read
      pull-requests: read
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          core: true
          cask: true

      - name: Cache Homebrew Bundler RubyGems
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-up-homebrew.outputs.gems-path }}
          key: ${{ matrix.os }}-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
          restore-keys: ${{ matrix.os }}-rubygems-

      - name: Clean up before testing
        run: brew test-bot --only-cleanup-before

      - name: Test formulas
        run: brew test-bot --only-formulae --skip-online-checks
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ github.token }}

      - name: Additional checks for new formulas
        if: needs.detect-changes.outputs.new_formulas != ''
        run: |
          echo "::notice::Testing new formulas: ${{ needs.detect-changes.outputs.new_formulas }}"
          for formula in ${{ needs.detect-changes.outputs.new_formulas }}; do
            echo "::group::Extended checks for new formula: $formula"
            
            # Strict audit for new formulas
            echo "Running strict audit..."
            brew audit --formula --strict --online "$formula" || true
            
            # Check if formula has a test block
            echo "Checking for test block..."
            if brew cat "$formula" | grep -q "def test"; then
              echo "âœ… Formula has a test block"
            else
              echo "::warning::Formula $formula does not have a test block"
            fi
            
            echo "::endgroup::"
          done

      - name: Upload bottles as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bottles_${{ matrix.os }}
          path: '*.bottle.*'

  # =============================================================================
  # CASK TESTING - Test casks (macOS only, separate from formulas)
  # =============================================================================
  test-casks:
    name: Test Casks (${{ matrix.os }})
    needs: [tap-syntax, detect-changes]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.has_cask_changes == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@main
        with:
          core: false
          cask: true

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Cache Homebrew Bundler RubyGems
        uses: actions/cache@v4
        with:
          path: ${{ steps.set-up-homebrew.outputs.gems-path }}
          key: ${{ matrix.os }}-rubygems-${{ steps.set-up-homebrew.outputs.gems-hash }}
          restore-keys: ${{ matrix.os }}-rubygems-

      - name: Tap the repository
        run: |
          brew tap "$GITHUB_REPOSITORY"

      - name: Audit casks
        run: |
          for cask in ${{ needs.detect-changes.outputs.casks }}; do
            echo "::group::Auditing cask: $cask"
            brew audit --cask --online "${{ github.repository_owner }}/tap/$cask" || true
            echo "::endgroup::"
          done

      - name: Strict audit for new casks
        if: needs.detect-changes.outputs.new_casks != ''
        run: |
          echo "::notice::Running strict audit for new casks: ${{ needs.detect-changes.outputs.new_casks }}"
          for cask in ${{ needs.detect-changes.outputs.new_casks }}; do
            echo "::group::Strict audit for new cask: $cask"
            
            # Strict audit for new casks
            brew audit --cask --strict --online "${{ github.repository_owner }}/tap/$cask" || true
            
            # Check for required stanzas
            echo "Checking cask structure..."
            CASK_CONTENT=$(brew cat --cask "${{ github.repository_owner }}/tap/$cask")
            
            if echo "$CASK_CONTENT" | grep -q "livecheck do"; then
              echo "âœ… Cask has livecheck block"
            else
              echo "::warning::Cask $cask does not have a livecheck block for auto-updates"
            fi
            
            if echo "$CASK_CONTENT" | grep -q "zap trash"; then
              echo "âœ… Cask has zap stanza"
            else
              echo "::warning::Cask $cask does not have a zap stanza"
            fi
            
            echo "::endgroup::"
          done

      - name: Fetch casks
        run: |
          for cask in ${{ needs.detect-changes.outputs.casks }}; do
            echo "::group::Fetching cask: $cask"
            brew fetch --cask --retry --force "${{ github.repository_owner }}/tap/$cask" || true
            echo "::endgroup::"
          done
        timeout-minutes: 30

      - name: Get list of installed apps before
        id: apps-before
        run: |
          ls -1 /Applications > /tmp/apps_before.txt || true
          ls -1 ~/Applications >> /tmp/apps_before.txt || true

      - name: Install and test casks
        run: |
          for cask in ${{ needs.detect-changes.outputs.casks }}; do
            echo "::group::Installing cask: $cask"
            if brew install --cask "${{ github.repository_owner }}/tap/$cask"; then
              echo "âœ… Installation successful"
              
              # Check what was installed
              echo "Checking installed artifacts..."
              brew info --cask --json=v2 "${{ github.repository_owner }}/tap/$cask" | jq -r '.casks[0].artifacts' || true
            else
              echo "::error::Failed to install cask: $cask"
            fi
            echo "::endgroup::"
          done
        timeout-minutes: 30

      - name: Uninstall casks
        if: always()
        run: |
          for cask in ${{ needs.detect-changes.outputs.casks }}; do
            echo "::group::Uninstalling cask: $cask"
            brew uninstall --cask --force "${{ github.repository_owner }}/tap/$cask" || true
            echo "::endgroup::"
          done
        timeout-minutes: 10

  # =============================================================================
  # CONCLUSION - Required check that depends on all test jobs
  # =============================================================================
  conclusion:
    name: Conclusion
    needs: [tap-syntax, detect-changes, test-formulas, test-casks]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "### ðŸ§ª Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          
          # Tap syntax is always required
          if [[ "${{ needs.tap-syntax.result }}" == "failure" ]]; then
            echo "âŒ **Tap Syntax**: Failed" >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Tap syntax check failed"
            exit 1
          elif [[ "${{ needs.tap-syntax.result }}" == "success" ]]; then
            echo "âœ… **Tap Syntax**: Passed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "â­ï¸ **Tap Syntax**: ${{ needs.tap-syntax.result }}" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          # Formula tests (only fail if there were formula changes and tests failed)
          if [[ "${{ needs.detect-changes.outputs.has_formula_changes }}" == "true" ]]; then
            if [[ "${{ needs.test-formulas.result }}" == "failure" ]]; then
              echo "âŒ **Formula Tests**: Failed" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::Formula tests failed"
              exit 1
            elif [[ "${{ needs.test-formulas.result }}" == "success" ]]; then
              echo "âœ… **Formula Tests**: Passed" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âš ï¸ **Formula Tests**: ${{ needs.test-formulas.result }}" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "â­ï¸ **Formula Tests**: Skipped (no formula changes)" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          # Cask tests (only fail if there were cask changes and tests failed)
          if [[ "${{ needs.detect-changes.outputs.has_cask_changes }}" == "true" ]]; then
            if [[ "${{ needs.test-casks.result }}" == "failure" ]]; then
              echo "âŒ **Cask Tests**: Failed" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::Cask tests failed"
              exit 1
            elif [[ "${{ needs.test-casks.result }}" == "success" ]]; then
              echo "âœ… **Cask Tests**: Passed" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "âš ï¸ **Cask Tests**: ${{ needs.test-casks.result }}" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "â­ï¸ **Cask Tests**: Skipped (no cask changes)" >> "$GITHUB_STEP_SUMMARY"
          fi
          
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "All required checks passed! âœ¨" >> "$GITHUB_STEP_SUMMARY"
